#!/bin/sh

#### tsthdweb
#### Created by Laurence D. Finston (LDF).

#### * (1) Copyright and License.

#### This file is part of GNU 3DLDF, a package for three-dimensional drawing.  
#### Copyright (C) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 
#### 2013, 2014, 2015, 2016, 2017, 2018 The Free Software Foundation  

#### GNU 3DLDF is free software; you can redistribute it and/or modify 
#### it under the terms of the GNU General Public License as published by 
#### the Free Software Foundation; either version 3 of the License, or 
#### (at your option) any later version.  

#### GNU 3DLDF is distributed in the hope that it will be useful, 
#### but WITHOUT ANY WARRANTY; without even the implied warranty of 
#### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
#### GNU General Public License for more details.  

#### You should have received a copy of the GNU General Public License 
#### along with GNU 3DLDF; if not, write to the Free Software 
#### Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

#### GNU 3DLDF is a GNU package.  
#### It is part of the GNU Project of the  
#### Free Software Foundation 
#### and is published under the GNU General Public License. 
#### See the website http://www.gnu.org 
#### for more information.   
#### GNU 3DLDF is available for downloading from 
#### http://www.gnu.org/software/3dldf/LDF.html.

#### Please send bug reports to Laurence.Finston@gmx.de
#### The mailing list help-3dldf@gnu.org is available for people to 
#### ask other users for help.  
#### The mailing list info-3dldf@gnu.org is for sending 
#### announcements to users. To subscribe to these mailing lists, send an 
#### email with ``subscribe <email-address>'' as the subject.  

#### The author can be contacted at: 

#### Laurence D. Finston 		   
#### c/o Free Software Foundation, Inc. 
#### 51 Franklin St, Fifth Floor 	   
#### Boston, MA  02110-1301  	   
#### USA                                

#### Laurence.Finston@gmx.de


## tsthdweb is a shell script that compares to files with the same
## name and different extensions using diff.  It is used for comparing
## old and new versions of the header files and the C++ code files
## generated by ctangle.  It is called in ./Makefile.am.  It's used,
## because I was not able to get the conditional construction into
## Makefile.am without causing errors.  LDF 2003.11.17.


## * (1) 

## First argument:  Filename without extension.

## Second Argument: 0 --- C++ and header files.
#                   1 --- C++ file only (main.web).
#                   2 --- Header file only (loader.web).


## * (1) 

if test $2 -lt 0 || test $2 -gt 2
then
   echo "ERROR! In tsthdweb: Invalid second argument: $2"
   echo "Returning 1."
   exit 1
fi


rm -f -r diff_res

if test $2 -eq 0  || test $2 -eq 1 # Test C++ file.
then
   if test ! -e $1.tmw
     then
        echo "$1.tmw doesn't exist.  Touching $1.tmw."
        touch $1.tmw
   fi
   file_a=$1.cxx
   file_b=$1.c


## This is just for insurance.  I don't think <filename>.c will ever fail to exist.
## LDF 2003.12.03.

   if test ! -e $file_b
      then
         echo "$file_b doesn't exist. Ctangling $1.web."
         $3 $1.web
	 cat cpyrtcpp.txt > AAAtmp.txt
	 echo >> AAAtmp.txt
	 cat $1.h >> AAAtmp.txt
	 mv AAAtmp.txt $1.h
   fi       

   if test ! -e $file_a
     then
       echo "$file_a doesn't exist. Renaming $file_b to $file_a, "
       echo "touching $1.tmw and exiting tsthdweb."
       mv $file_b $file_a
       touch $1.tmw
       exit 0
   fi
fi

if test $2 -eq 0 || test $2 -eq 2 # Test header file.
   then
      file_c=$1.h
      file_d=$1.hbk

## This is just for insurance.  I don't think <filename>.h will ever fail to exist.
## LDF 2003.12.03.

      if test ! -e $file_c
      then
         echo "$file_c doesn't exist. Ctangling $1.web."
         $3 $1.web
	 cat cpyrtcpp.txt > AAAtmp.txt
	 echo >> AAAtmp.txt
	 cat $1.h >> AAAtmp.txt
	 mv AAAtmp.txt $1.h
      fi       

      if test ! -e $file_d
        then
          echo "$file_d doesn't exist. Touching $1.tim and exiting tsthdweb."
          touch $1.tim
          exit 0
      fi
fi


cxx_changed=0
header_changed=0

if test $2 -eq 0 || test $2 -eq 1  # Test C++ file.
   then
      diff -q -w -B -I '^[[:space:]]*\(#line\|/\*\)' $file_a $file_b > diff_res
      # cat diff_res
      if test -s diff_res 
         then
             echo "$file_b has changed."
             echo "Renaming $1.c to $1.cxx."
             rm -f -r $1.cxx
             mv $1.c $1.cxx
             echo "Touching $1.tmw."
             touch $1.tmw
             cxx_changed=1
         else
             echo "$1.c hasn't changed. Deleting $1.c."
             rm -f -r $1.c
             touch $1.tmw --reference=$1.cxx
      fi
fi


if test $2 -eq 0 || test $2 -eq 2 # Test header file.
   then
       diff -q -w -B -I '^[[:space:]]*\(#line\|/\*\)' $file_c $file_d > diff_res
       if test -s diff_res 
          then 
             #cat diff_res
             echo "$file_c has changed."
             echo "Touching $1.tim."
             touch $1.tim
             header_changed=1
          else
             echo "$file_c hasn't changed."
             rm -f -r $1.h
             cp -p $1.hbk $1.h
             touch $1.tim --reference=$1.hbk
        fi
fi

if test $cxx_changed -eq 0 && test $header_changed -eq 0
   then
     if test $1.tim -ot $1.tmw
        then
            echo "Setting timestamp of $1.web to that of $1.tim."
            touch $1.web --reference=$1.tim
        else
            echo "Setting timestamp of $1.web to that of $1.tmw."
            touch $1.web --reference=$1.tmw
     fi
     echo "You will have to revert the buffer of $1.web"
     echo "if you're currently, working on it, because this changes it on disk."
#### This caused a problem, and I don't think I need it.  LDF 2003.12.09.
# elif test $cxx_changed -eq 0 && test $header_changed -eq 1
#      then
#              echo "Setting timestamp of $1.tmw to that of $1.tim."
#              touch $1.tmw --reference=$1.tim
# elif test $cxx_changed -eq 1 && test $header_changed -eq 0
#      then
#              echo "Setting timestamp of $1.tim to that of $1.tmw."
fi            




rm -fr $1.hbk
rm -fr diff_res



